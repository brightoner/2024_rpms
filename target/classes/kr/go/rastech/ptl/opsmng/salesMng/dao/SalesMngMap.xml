<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.rastech.ptl.opsmng.salesMng.dao.SalesMngDao">
 <sql id="getPagingSelect">
   SELECT  @rownum:=@rownum+1 as  data_seq, D.*
     FROM (
 </sql>

 <sql id="getPagingWhere">
 <![CDATA[
             ) D		 
	    LIMIT #{length, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 ]]>
 </sql>
 
 	<!-- 매출관리 list -->
	<select id="selectSaleMngList"  parameterType="java.util.Map"  resultType="kr.go.rastech.commons.utils.LowerKeyMap">
 	/* selectSaleMngList */ 	
		<include refid="getPagingSelect"></include>
		SELECT  A.SALES_ID
			  , A.SALES_ITEM_NM
			  , A.SALES_REVENUE
			  , A.SALES_CLIENT_NM
			  , DATE_FORMAT(A.SALES_TRADE_DT,'%Y-%m-%d') AS SALES_TRADE_DT
			  , A.CREATE_ID
			  , DATE_FORMAT(A.CREATE_DTTM,'%Y-%m-%d') AS CREATE_DTTM
			  , A.FILE_GROUP_SALES
			  , A.MODIFY_ID
			  , A.MODIFY_DTTM
		  FROM  PTL_SALES_MNG A, (SELECT @rownum:= #{rownum, jdbcType=INTEGER}) R
		 WHERE  1=1
		 <if test="searchword != null and searchword != ''">
			<if test ="searchopt == 'item'">
				  AND A.SALES_ITEM_NM like concat('%',#{searchword},'%')
			</if>
			<if test ="searchopt == 'name'">
				  AND A.SALES_CLIENT_NM like concat('%',#{searchword},'%')
			</if>
		</if>
 	  ORDER BY  A.SALES_ITEM_NM DESC
	 	<include refid="getPagingWhere"></include>
	</select>
	
	<!-- 매출관리 list count -->
	<select id="selectSaleMngListCount"  parameterType="java.util.Map"  resultType="integer">
	/* selectSaleMngListCount */ 
		SELECT  COUNT(1)
		  FROM  PTL_SALES_MNG
		 WHERE  1=1
		 <if test="searchword != null and searchword != ''">
			<if test ="searchopt == 'item'">
				  AND SALES_ITEM_NM like concat('%',#{searchword},'%')
			</if>
			<if test ="searchopt == 'name'">
				  AND SALES_CLIENT_NM like concat('%',#{searchword},'%')
			</if>
		</if>
	</select>
	
	
	<!-- 매출관리 상세보기 -->
	<select id="selectSaleMngDtl"  parameterType="java.util.Map"  resultType="kr.go.rastech.commons.utils.LowerKeyMap">
	/* selectSaleMngDtl */
		SELECT  SALES_ID
	  		  , SALES_ITEM_NM
			  , SALES_REVENUE
			  , SALES_CLIENT_NM
			  , DATE_FORMAT(SALES_TRADE_DT,'%Y-%m-%d') AS SALES_TRADE_DT
			  , FILE_GROUP_SALES
			  , CREATE_ID
			  , DATE_FORMAT(CREATE_DTTM,'%Y-%m-%d') AS CREATE_DTTM
			  , MODIFY_ID
			  , DATE_FORMAT(MODIFY_DTTM,'%Y-%m-%d') AS MODIFY_DTTM
		FROM  PTL_SALES_MNG 
	   WHERE  SALES_ID = ${sales_id}
	</select>	
	
	
	<!-- 매출관리 등록 -->
	<insert id="insertSaleMng" parameterType="java.util.Map">
	/* insertSaleMng */
		  INSERT INTO PTL_SALES_MNG (
				  SALES_ID
				, SALES_ITEM_NM
				, SALES_REVENUE
				, SALES_CLIENT_NM
				, SALES_TRADE_DT
				, FILE_GROUP_SALES
				, CREATE_ID
				, CREATE_DTTM
			) VALUES (
				<choose>
					<when test="sales_id != null and sales_id != ''">
						#{sales_id, jdbcType=VARCHAR}	
					</when>		
					<otherwise>
						NEXTVAL(PTL_SALES_MNG_SEQ)
					</otherwise>			
				</choose>
				, #{sales_item_nm, jdbcType=VARCHAR}	
				, #{sales_revenue, jdbcType=VARCHAR}	
				, #{sales_client_nm, jdbcType=VARCHAR}	
				, (CASE WHEN DATE_FORMAT(STR_TO_DATE(#{sales_trade_dt, jdbcType=VARCHAR}, '%Y-%m-%d'), '%Y%m%d') = '00000000' THEN '' 
				        ELSE DATE_FORMAT(STR_TO_DATE(#{sales_trade_dt, jdbcType=VARCHAR}, '%Y-%m-%d'), '%Y%m%d') 
				   END)
				, #{file_group_sales, jdbcType=VARCHAR}	
				, #{create_id, jdbcType=VARCHAR}	
				, NOW()
			) ON DUPLICATE KEY UPDATE
				  SALES_ITEM_NM = #{sales_item_nm, jdbcType=VARCHAR}
				, SALES_REVENUE = #{sales_revenue, jdbcType=VARCHAR}	
				, SALES_CLIENT_NM = #{sales_client_nm, jdbcType=VARCHAR}	
				, SALES_TRADE_DT = (CASE WHEN DATE_FORMAT(STR_TO_DATE(#{sales_trade_dt, jdbcType=VARCHAR}, '%Y-%m-%d'), '%Y%m%d') = '00000000' THEN '' 
									     ELSE DATE_FORMAT(STR_TO_DATE(#{sales_trade_dt, jdbcType=VARCHAR}, '%Y-%m-%d'), '%Y%m%d') 
									END)
				, FILE_GROUP_SALES = #{file_group_sales, jdbcType=VARCHAR}	
				, MODIFY_ID = #{modify_id, jdbcType=VARCHAR}	
				, MODIFY_DTTM = NOW()
    </insert>
    
    
    <!-- 매출관리 삭제 -->
	<delete id="deleteSaleMng" parameterType="java.util.Map">
	/* deleteSaleMng */
		DELETE
		  FROM  PTL_SALES_MNG
		 WHERE  1=1
		   AND  SALES_ID = #{sales_id} 
		
	</delete>
	
	
	
	
</mapper>
