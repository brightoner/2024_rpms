<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.go.rastech.ptl.follow.end.sales.dao.EndSalesDao">
 <sql id="getPagingSelect">
   SELECT  @rownum:=@rownum+1 as  data_seq, D.*
     FROM (
 </sql>

 <sql id="getPagingWhere">
 <![CDATA[
             ) D		 
	    LIMIT #{length, jdbcType=INTEGER} OFFSET #{start, jdbcType=INTEGER}
 ]]>
 </sql>
 
 
 <!-- 매출관리 list -->
	<select id="selectEndSaleMngList"  parameterType="java.util.Map"  resultType="kr.go.rastech.commons.utils.LowerKeyMap">
 	/* selectEndSaleMngList */ 	
		<include refid="getPagingSelect"></include>
			SELECT  A.SALES_ID
				  , A.SALES_ITEM_NM
				  , A.SALES_REVENUE
				  , A.SALES_CLIENT_NM
				  , A.SALES_TRADE_DT
				  , A.FILE_GROUP_SALES
			  FROM  PTL_SALES_MNG A
		 LEFT JOIN  PTL_END_FOLLOW_SALES B 
		        ON  A.SALES_ID = B.SALES_ID
			   AND  B.PROJ_END_ID = #{proj_end_id_sales}
		INNER JOIN  (SELECT @rownum:= #{rownum, jdbcType=INTEGER}) R
		     WHERE  1=1
			   AND  B.END_SALES_ID IS NULL
		 <if test="searchword != null and searchword != ''">
			<if test ="searchopt == 'item'">
				  AND A.SALES_ITEM_NM like concat('%',#{searchword},'%')
			</if>
			<if test ="searchopt == 'name'">
				  AND A.SALES_CLIENT_NM like concat('%',#{searchword},'%')
			</if>
		</if>
 	  ORDER BY  A.SALES_ITEM_NM DESC
	 	<include refid="getPagingWhere"></include>
	</select>
	
	<!-- 매출관리 list count -->
	<select id="selectEndSaleMngListCount"  parameterType="java.util.Map"  resultType="integer">
	/* selectEndSaleMngListCount */ 
			SELECT  COUNT(1)
			  FROM  PTL_SALES_MNG A
		 LEFT JOIN  PTL_END_FOLLOW_SALES B 
		        ON  A.SALES_ID = B.SALES_ID
			   AND  B.PROJ_END_ID = #{proj_end_id_sales}
		     WHERE  1=1
			   AND  B.END_SALES_ID IS NULL
		 <if test="searchword != null and searchword != ''">
			<if test ="searchopt == 'item'">
				  AND A.SALES_ITEM_NM like concat('%',#{searchword},'%')
			</if>
			<if test ="searchopt == 'name'">
				  AND A.SALES_CLIENT_NM like concat('%',#{searchword},'%')
			</if>
		</if>
	</select>
 
	<!--  최종사후관리 매출 list -->
	<select id="selectEndSalesList" parameterType="java.util.Map"  resultType="kr.go.rastech.commons.utils.LowerKeyMap">
	/* selectEndSalesList */
	  SELECT  A.END_SALES_ID
		    , A.PROJ_END_ID
		    , A.SALES_ID
		    , IFNULL(A.SALES_CONTRIBUTE, '') AS SALES_CONTRIBUTE 
		    , A.CREATE_ID
		    , A.CREATE_DTTM
		    , A.MODIFY_ID
		    , A.MODIFY_DTTM
		    , B.SALES_ITEM_NM
		    , B.SALES_REVENUE
		    , B.SALES_CLIENT_NM
		    , B.SALES_TRADE_DT
		    , B.FILE_GROUP_SALES
		    , GROUP_CONCAT(C.FILE_ID ORDER BY C.FILE_ID) AS FILE_IDS
		    , GROUP_CONCAT(C.ORGN_FILE_NM ORDER BY C.FILE_ID) AS ORGN_FILE_NMS
		FROM  PTL_END_FOLLOW_SALES A
  INNER JOIN  PTL_SALES_MNG B 
          ON  A.SALES_ID = B.SALES_ID
   LEFT JOIN  PTL_ATCHFILE C 
          ON  B.FILE_GROUP_SALES = C.FILE_GROUP
	   WHERE  A.PROJ_END_ID = #{proj_end_id_sales}
	GROUP BY  A.END_SALES_ID
		    , A.PROJ_END_ID
		    , A.SALES_ID
		    , A.SALES_CONTRIBUTE
		    , A.CREATE_ID
		    , A.CREATE_DTTM
		    , A.MODIFY_ID
		    , A.MODIFY_DTTM
		    , B.SALES_ITEM_NM
		    , B.SALES_REVENUE
		    , B.SALES_CLIENT_NM
		    , B.SALES_TRADE_DT
		    , B.FILE_GROUP_SALES
	</select>
	
	<!--  최종사후관리 매출 list count -->
	<select id="selectEndSalesListCount" parameterType="java.util.Map"  resultType="integer">
	/* selectEndSalesListCount */
		SELECT  COUNT(1)
		  FROM  PTL_END_FOLLOW_SALES A
	INNER JOIN  PTL_SALES_MNG B
		    ON  A.SALES_ID =B.SALES_ID    
		 WHERE  1=1
		   AND  A.PROJ_END_ID = #{proj_end_id_sales}
	</select>
	
	<!-- 최종사후관리 매출 등록 -->
	<insert id="insertEndSales" parameterType="java.util.Map">
	/* insertEndSales */
		INSERT INTO PTL_END_FOLLOW_SALES (
			      END_SALES_ID
			    , PROJ_END_ID
				, SALES_ID
				, SALES_CONTRIBUTE
				, CREATE_ID
				, CREATE_DTTM
			) VALUES (
				NEXTVAL(ptl_end_follow_sales_seq)
				, #{proj_end_id, jdbcType=VARCHAR}	
				, #{sales_id, jdbcType=VARCHAR}	
				, #{sales_contribute, jdbcType=VARCHAR}	
				, #{create_id, jdbcType=VARCHAR}
				, NOW()
			)
	</insert>
	
	
	<!-- 최종사후관리 매출 업데이트 -->
	<update id="updateEndSales" parameterType="java.util.Map">
	/* updateEndSales */
		UPDATE  PTL_END_FOLLOW_SALES
   		   SET  SALES_CONTRIBUTE = #{sales_contribute, jdbcType=VARCHAR}
			  , MODIFY_ID = #{modify_id, jdbcType=VARCHAR}
			  , MODIFY_DTTM = NOW()
		 WHERE  1=1
		   AND  END_SALES_ID = #{end_sales_id}
	</update>
	
	
	<!-- 최종사후관리 매출 삭제 -->
	<delete id="deleteEndSales" parameterType="java.util.Map">
	/* deleteEndSales */
		DELETE 
		  FROM  PTL_END_FOLLOW_SALES
		 WHERE  1=1
		   AND  END_SALES_ID = #{end_sales_id}
	</delete>
	
	
	
</mapper>
